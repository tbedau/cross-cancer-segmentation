# Scoring Analysis

R/Quarto analysis for generating publication figures and tables from the segmentation scoring data. The analysis covers model performance across TCGA projects, inter-rater reliability, and Dice coefficient validation.

## Prerequisites

- R (>= 4.4) and RStudio
- Research data downloaded via `./download_data.sh` at the repository root (see [main README](../README.md#data))

## Setup

1. Open `scoring-analysis.Rproj` in RStudio.

2. Restore the R package environment:

    ```r
    renv::restore()
    ```

3. Open `figures-for-pub.qmd` and render or run individual cells.

## Input Data

All data files live in `../data/` (downloaded via `download_data.sh`):

| File / Directory | Used for |
|------------------|----------|
| `scoring_data.csv` | Primary rater scores (Figures 1, 4, 6, Table 1) |
| `scoring_data_second_rater.csv` | Second rater scores (Figure 3A–B, inter-rater reliability) |
| `pathologist_inference_ratings.csv` | Manual ROI ratings for Dice validation (Figure 3E) |
| `dice-results/` | Per-ROI Dice coefficients (Figure 3C–E) |
| `clinical-data/` | TCGA clinical metadata for diagnosis-level analyses (Figure 6) |

## Generated Outputs

All outputs are written to `output/`:

### Figures

| File | Description |
|------|-------------|
| `fig_3_a.svg` | Inter-rater scatter plots with Spearman/ICC per model |
| `fig_3_c.svg` | Dice score distributions by model and cohort |
| `fig_3_e.svg` | Manual score vs. Dice correlation with tolerance bands |
| `fig_4_a.svg` | Overall score distributions by model (boxplot) |
| `fig_4_b.svg` | Mean scores per TCGA project and model (heatmap) |
| `fig_4_c.svg` | Score distributions faceted by TCGA project |
| `fig_4_d.svg` | Mean scores per project ranked within each model |
| `fig_6_b_1.svg` | Non-lung squamous cell carcinoma subgroup |
| `fig_6_b_2.svg` | Diffuse/signet ring cell adenocarcinoma subgroup |
| `suppl_fig_6_a.svg` | Diagnosis distribution for squamous subgroup |
| `suppl_fig_6_b.svg` | Diagnosis distribution for diffuse/signet subgroup |

### Tables

| File | Description |
|------|-------------|
| `table_1.png` | Mean ± SD scores by TCGA project and model |

Figures 3B and 3D produce inline data frames (ICC/Spearman summary and mean Dice summary) that are displayed in the rendered HTML but not saved as separate files.

## Key R Packages

| Package | Purpose |
|---------|---------|
| `tidyverse` | Data wrangling and ggplot2 visualization |
| `irr` | ICC computation for inter-rater reliability |
| `gt` / `gtsummary` | Publication-quality tables |
| `patchwork` | Multi-panel figure composition |
| `svglite` | SVG output for figures |
| `janitor` | Column name cleaning for Dice result CSVs |

## Notes

- Figures 2 and 5 are image panels assembled outside R and are not generated by this notebook.
- The five segmentation models are labeled by the organ they were trained on: Breast, Colon, Lung, Kidney, Prostate.
- Color palette follows a consistent five-color scheme across all figures: `#0077BB` (Breast), `#33BBEE` (Colon), `#009988` (Lung), `#EE7733` (Kidney), `#CC3311` (Prostate).
